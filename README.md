# フォーミュラ研 データロガー

## 構成

現在は以下のものを使用し、ロガーを構成している。

- client
- data-server
- realtime-server
- webapp
- analyze

上記以外のものは既に使用していない。

### client

データを取得するロガー本体のプログラム。  
リアルタイム性確保のため、Raspberry Pi PicoにC/C++で開発。  
リアとフロントの二つのマイコンにセンサー類をぶら下げ、車載データサーバに送信しているもの。  
MQTTで送信することを考えてtopicとjson形式のpayloadを送っている。  

### data-server

車載のデータ保存用データサーバ。  
並列処理を行うため、Go言語を採用。  
データの保存やネットワーク処理など高級なことをするのでOSが乗るRaspberry Pi zero 2Wでの動作を想定。  
サーバが起動するたびにファイルを新しく作成している。  
そのため、ロガーの電源が切れるたびに新たなデータファイルに書き出されている。  
以下三つのプロセスが走るように設計。

- serial
- mqtt
- api

#### Serial

ロガーから送られてきたデータを受信し、CSVファイルに保存するもの。  
ネットワークエラーによりプロセスが停止することが無いようにMQTTなどとはプロセスごと分離。  
プロセス間にはUnixソケット通信を採用。  
ネットワークに流すデータ数を制限することも行っている。

#### MQTT

Unixソケットを通じて流れてきたデータをMQTTを用いてリアルタイムサーバに送信する。  
ロガーの中でtopicとpayloadは組み立て終わっているため、ただ流すだけ。

#### API

保存したCSVファイルをサーバにログインすることなく取得することができるようにするためのAPIサーバ。  
以下のエントリポイントを通して全件データを取得可能。  
後から解析することを考えているため、特に加工することなく返却している。

- /
    存在するデータの名称を一覧で返却
- /<name>
    データ名に一致する内容をCSV形式で返却

### realtime-server

リアルタイムで監視するためのサービスを提供するサーバ。  
並列処理かつ、サーバ用途のため、Go言語を採用。  
保存するデータベースとして長期的に保存する必要が無いため、インメモリのSQLiteを採用。  
地上で動作するRaspberry Piシリーズを想定して開発。  
また、次のウェブアプリのページサーバとしての機能を併せ持つ。  

リアルタイムでの監視が主なため、一部のデータは単位変換や、スケールの変換を行いわかりやすくしている。  
以下のエントリポイントを通し、MQTTに流れてきたデータを返却している。  

- /
    ページ返却用。  主にスマホなどからアクセスするURL。
- /latest/<n>
    最新N件のデータ取得用。
- /range?from=1234%to=5678
    特定の期間のデータを返却。Unix秒での指定。

データ取得ではfieldsというクエリパラメータにより、欲しいデータの種類を選択可能。

### webapp

リアルタイムで監視するためのアプリ。  
ウェブアプリ用途のためSolid.jsをtypescriptを用いて開発。  
スタイルにはvanilla-extractとopen-propsを組み合わせて軽量かつ手軽に開発可能。  
サーバに埋め込むことを考えて、ビルド後はindex.html一枚のみを生成する。  
現在は最新N件をフィールド三種類のみ対応。

### analyze

データサーバに保存されているCSVを解析しやすいCSVに変換するプログラム+グラフ化を少し。  
データ処理やグラフ化の手軽さを考慮しPythonで作成。  
各topicごとにCSVファイルが作成される。  
各セクションの人が使いやすいように単位変換などをかましてある。

### 既に放棄したもの

以下のものは既に使用を中止している。

- server
    データサーバとリアルタイム用サーバを分ける前のサーバのコード。  
    機能の分割に伴い放棄。
- mqtt-client
    車載のウェブ通信をマイコンからSBCに移行する前のマイコンのコード。  
    ESP-IDFを用いてSeeed XIAO ESP32S3を想定してCで開発。  
    デバッグが困難だったことに加え、車載側でデータを全件保存するために放棄。
- preview
    リアルタイムのサーバとウェブアプリが作成できる前に使用したリアルタイム監視用のプレビュー用コード。  
    グラフ化の容易さと開発期間の短さを考えPythonで作成。  
    他の人が使いづらいことを理由に放棄。
- rpm-probe
    学生フォーミュラ大会当日にテザリングでWi-Fiが機能しないことを受け、騒音検査のためにRPMの表示だけをするために作成。  
    Seeed XIAO RP2040を想定したprobeのコードとprobeのデータを既存のリアルタイムサービスに接続するためのclientのコードで構成されている。  
    probeはロガーのコードを流用するためにCで開発し、clientは開発時間の短さを理由にPythonで作成。  
    大学での走行会は特にテザリングが多いといったことも無いため放棄。

